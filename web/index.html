<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap 101 Template</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="jumbotron">
    <h1>NOT-CMS Status</h1>
    </div>



      <div class="container">
        <div class="" id="result">
            <div class="" role="alert" id="result2"></div>        
        </div>        
      </div>
    

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
    <script type="text/javascript">
    
        var nagios = -1;

        function run(){        
            $.get("nagios.txt",
                function( data ){
                    if (nagios == -1){
                        nagios = data;
                    } else if( nagios != data){
                        nagios = data;
                        notifyMe();
                    }
                    updateStatus(data);
                }
            );
        }   

        function loadErrorMsg(){
            $.get("errormessage.txt",
                function( data ){
                    updateErrorMsg(data);
                }
            );
        }

        function updateStatus( data ){

            data = parseInt(data);
            switch (data)
            { 
                case 0:
                    $("#result").removeClass();
                    updateErrorMsg("Es liegt keine Störung vor.");
                    $("#result").addClass("alert alert-success glyphicon glyphicon-ok-circle");
                    break;
                case 1: 
                    $("#result").removeClass();
                    $("#result").addClass("alert alert-warning glyphicon glyphicon-time");
                    loadErrorMsg();
                    break;
                case 2: 
                    $("#result").removeClass();
                    $("#result").addClass("alert alert-danger glyphicon glyphicon-fire");
                    loadErrorMsg();
                    break;
                default:
                    $("#result").removeClass();
                    $("#result").addClass("alert alert-info glyphicon glyphicon-off");
                    updateErrorMsg("Die Überwachung ist abgeschaltet");
            }
        }
        
        function updateErrorMsg( msg ){
            $("#result2").text(msg);
        }

        run();
        setInterval(run, 5000);


        var notification;

        function clearNotify(){
            notification.close();
        }

        function notifyMe() {
          // Let's check if the browser supports notifications
          if (!("Notification" in window)) {
            alert("This browser does not support desktop notification");
          }

          // Let's check if the user is okay to get some notification
          else if (Notification.permission === "granted") {
            // If it's okay let's create a notification       
            if (notification) {
                notification.close();
            }
            notification = new Notification("NOT-CMS Status changed");
            setTimeout(clearNotify,5000);
          }

          // Otherwise, we need to ask the user for permission
          // Note, Chrome does not implement the permission static property
          // So we have to check for NOT 'denied' instead of 'default'
          else if (Notification.permission !== 'denied') {
            Notification.requestPermission(function (permission) {
              // Whatever the user answers, we make sure we store the information
              if (!('permission' in Notification)) {
                Notification.permission = permission;
              }

              // If the user is okay, let's create a notification
              if (permission === "granted") {
                if (notification) {
                    notification.close();
                }
                notification = new Notification("NOT-CMS Status changed");
                setTimeout(clearNotify,5000);
              }
            });
          }

          // At last, if the user already denied any notification, and you 
          // want to be respectful there is no need to bother them any more.
        }        
    </script>
  </body>
</html>